<?xml version="1.0" ?>
<odoo>
	<data>
		<template id="perfume_start_01_drop_optimized_template" name="Perfume Start Step 01">
			<t t-call="website.layout">
				<t t-set="title">Perfume Journey - Step 1</t>
				<t t-set="additional_title">Scentzania</t>
				<t t-set="font_url" t-value="request.env['ir.config_parameter'].sudo().get_param('gm_scentopia.font_link')"/>
				<t t-set="font_family" t-value="request.env['ir.config_parameter'].sudo().get_param('gm_scentopia.font_name')"/>

				<t t-if="font_url">
						<link rel="stylesheet" t-att-href="font_url"/>
				</t>
				<style>
					body {
						font-family: "<t t-esc="font_family or 'Poppins'"/>" !important;
					}
					.perfume-wrapper {
						min-height: 100vh;
						padding-top: 60px;
						padding-bottom: 20px;
					}
					
					.category-header {
						background-color: rgba(255, 255, 255, 0.6);
						margin: -2px -1px 22px;
						top: 0;
						z-index: 10;
					}
					
					.bubble {
						position: relative;
						font-size: 12px;
						line-height: 14px;
						background: #fff;
						border-radius: 40px;
						padding: 15px;
						text-align: center;
						color: #000;
						border: 1px solid #fff;
					}

					.bubble-bottom-right:before {
						content: "";
						width: 0px;
						height: 0px;
						position: absolute;
						border-right: 24px solid #fff;
						border-left: 12px solid transparent;
						border-top: 12px solid #fff;
						border-bottom: 20px solid transparent;
						right: 32px;
						bottom: -24px;
					}
					/* Category-specific styles */
					.perfume-wrapper.citrus {
						background-image: url('/gm_web/static/src/img/05_perfume_start_01_citrus.png');
						background-color: #FFB347;
						background-size: cover;
						background-position: center;
						transition: all 0.5s ease;
					}
					
					.perfume-wrapper.fresh {
						background-image: url('/gm_web/static/src/img/05_perfume_start_01_fresh.png');
						background-color: #4FC3F7;
						background-size: cover;
						background-position: center;
						transition: all 0.5s ease;
					}
					
					.perfume-wrapper.floral {
						background-image: url('/gm_web/static/src/img/05_perfume_start_01_floral.png');
						background-color: #FF6B9D;
						background-size: cover;
						background-position: center;
						transition: all 0.5s ease;
					}
					
					.perfume-wrapper.woody {
						background-image: url('/gm_web/static/src/img/05_perfume_start_01_woody.png');
						background-color: #8B4513;
						background-size: cover;
						background-position: center;
						transition: all 0.5s ease;
					}
					
					.perfume-wrapper.oriental {
						background-image: url('/gm_web/static/src/img/05_perfume_start_01_oriental.png');
						background-color: #D32F2F;
						background-size: cover;
						background-position: center;
						transition: all 0.5s ease;
					}
					
					.citrus .btn, .citrus #scanQRSpan {
						background-color: #fff7ccE6 !important;
						color: #000 !important;
					}
					
					.fresh .btn, .fresh #scanQRSpan {
						background-color: #d4f1f9E6 !important;
						color: #000 !important;
					}
					
					.floral .btn, .floral #scanQRSpan {
						background-color: #ffd6e7E6 !important;
						color: #000 !important;
					}
					
					.woody .btn, .woody #scanQRSpan {
						background-color: #e6d5b8E6 !important;
						color: #000 !important;
					}
					
					.oriental .btn, .oriental #scanQRSpan {
						background-color: #f9d5d5E6 !important;
						color: #000 !important;
					}
				</style>

				<div id="perfumeStartWrapper" t-att-class="'perfume-wrapper d-flex flex-column position-relative ' + category">
					<div id="categoryHeader" class="category-header d-flex justify-content-between align-items-center position-fixed w-100 py-2 px-3" style="color:black !important; top: 0;">
						<t t-if="location == 'team_building'">
							<div class="text-start">
								<span id="categoryCounter" class="d-block">This Is your <t t-esc="oil_order"/> Oil</span>
								<span id="scentType" class="d-block small"> <t t-esc="category.capitalize()"/> Scent Wand</span>
							</div>
							<div class="text-end">
								<span id="totalCounter" class="d-block"><t t-esc="oil_added_count"/> / <t t-esc="oil_max"/> Drops</span>
								<span id="totalCounterText" class="d-block small">Remaining <t t-esc="oil_max - oil_added_count"/> Drops </span>
							</div>
						</t>
						<t t-else="">
							<div class="text-start">
								<span id="categoryCounter" class="d-block">This <t t-esc="oil_added_count+1"/> / <t t-esc="int(oil_max)"/></span>
								<span id="scentType" class="d-block small"> <t t-esc="category.capitalize()"/> Scent Wand</span>
							</div>
							<div class="text-end">
								<span id="totalCounter" class="d-block"><t t-esc="oil_added_all+1"/> / <t t-esc="int(oil_max_all)"/></span>
								<span id="totalCounterText" class="d-block small">Total scent wands</span>
							</div>
						</t>
					</div>
					
					<div class="flex-fill d-flex flex-column justify-content-center align-items-center p-3" style="padding-bottom:30% !important;">
						<div class="w-100" style="max-width: 400px;">
							<div class="d-flex gap-2">
								<input type="text" id="scentCodeInput" placeholder="Input scent code" class="form-control rounded-pill flex-fill shadow-sm" style="padding: 14px 20px; border: 2px solid #fff7cc; background: #fff;"/>
								<button type="button" id="checkButton" class="btn rounded-pill fw-semibold text-dark shadow-sm" style="min-width: 100px; padding: 14px 16px;">
									Check
								</button>
							</div>
							<div class="text-center mt-2">
								<span id="scanQRSpan" class="d-inline-block py-2 px-3 small rounded-3 shadow-sm text-dark" style="cursor: pointer; ">or Scan QR</span>
							</div>
						</div>
					</div>
				</div>

				<div class="fixed-bottom d-flex align-items-center justify-content-between p-3"
                    style="z-index: 1000;">
                    <a href="/perfume-journey/fragrance-selection" class="text-decoration-none d-flex align-items-center justify-content-center" style="background:#F9F2F0 !important; border-radius:15px;">
                        <img src="/gm_web/static/src/img/prev.svg" alt="Back" class="img-fluid" style="width: 40px; height: 40px; object-fit: contain;"/>
                    </a>
                    <img src="/gm_web/static/src/img/logo.png" class="img-fluid" style="width: 150px; margin-right:30px; margin-top:-20px;" alt="Logo"/>
                    <div style="width: 40px;"></div>
                </div>

				
				<div class="fixed-bottom p-3" style="z-index: 2000; pointer-events: none;">
					<div class="bubble bubble-bottom-right text-brown ms-auto me-2 mb-4" style="max-width: 400px;">
						<p class="mb-0" id="triviaContent">
							<h3>You are <t t-esc="oil_percentage"/>% <t t-esc="category.capitalize()"/></h3>
							<p><t t-esc="fragrance_text"/></p>
						</p>
					</div>
					<div class="text-end me-2">
						<img t-att-src="'data:%s;base64,%s' % (avatar.get_image_mime('other'), avatar.decode_image(avatar.image))"
							alt="Avatar Image"
							class="img-fluid"
							style="height: 100px;" />
					</div>
				</div>
				<script>
					<![CDATA[
					document.addEventListener('DOMContentLoaded', function() {
						// Get category from the wrapper element
						const perfumeWrapper = document.getElementById('perfumeStartWrapper');
						const selectedCategory = perfumeWrapper.className.split(' ').find(cls => 
							['citrus', 'fresh', 'floral', 'woody', 'oriental'].includes(cls)
						) || '';

						const scanSpan = document.getElementById('scanQRSpan');
						// Auto-update trivia content every 10 minutes
						function updateTriviaContent() {
							fetch('/api/get-trivia-helpfull-content')
								.then(response => response.json())
								.then(data => {
									const triviaElement = document.getElementById('triviaContent');
									if (triviaElement && data.content) {
										triviaElement.innerHTML = data.content;
									}
								})
								.catch(error => {
									console.error('Error fetching trivia content:', error);
								});
						}

						// Start updating after 10 minutes (600000 milliseconds)
						setTimeout(() => {
							updateTriviaContent();
							// Continue updating every 10 minutes
							setInterval(updateTriviaContent, 600000);
						}, 600000);
						
						document.getElementById('checkButton').addEventListener('click', function() {
						const scentCode = document.getElementById('scentCodeInput').value.trim();
						
						if (!scentCode) {
							alert('Please enter a scent code');
							return;
						}

						this.textContent = 'Checking...';
						this.disabled = true;

						fetch('/perfume-journey/api/validate-oil-code', {
							method: 'POST',
							headers: {
							'Content-Type': 'application/json',
							'X-Requested-With': 'XMLHttpRequest'
							}, body: JSON.stringify({
							params: { scent_code: scentCode, category: selectedCategory }
							})
						})
						.then(response => response.json())
						.then(data => {
							const result = data.result;
							if (result.success) {
							window.location.href = result.redirect_url;
							} else {
							alert(result.message);
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert('Error searching for scent code');
						})
						.finally(() => {
							this.textContent = 'Check';
							this.disabled = false;
						});
						});

						// === SCAN QR POPUP ===
						scanSpan.addEventListener('click', async function() {
						if (!window.Html5Qrcode) {
							await new Promise((resolve, reject) => {
							const script = document.createElement('script');
							script.src = 'https://unpkg.com/html5-qrcode';
							script.onload = resolve;
							script.onerror = reject;
							document.head.appendChild(script);
							});
						}

						const overlay = document.createElement('div');
						overlay.id = 'qrModalOverlay';
						Object.assign(overlay.style, {
							position: 'fixed',
							top: 0, left: 0, width: '100%', height: '100%',
							background: 'rgba(0, 0, 0, 0.7)',
							display: 'flex',
							justifyContent: 'center',
							alignItems: 'center',
							zIndex: 9999
						});

						const container = document.createElement('div');
						Object.assign(container.style, {
							background: '#fff',
							borderRadius: '16px',
							padding: '15px',
							textAlign: 'center',
							maxWidth: '340px',
							width: '90%',
							boxShadow: '0 4px 20px rgba(0,0,0,0.3)',
							position: 'relative'
						});

						container.innerHTML = `
							<h5 style="margin-bottom:10px;">Scan QR Code</h5>
							<div id="qr_reader" style="width:280px; margin:auto;"></div>
							<button id="closeScannerBtn" style="
							margin-top:15px; padding:8px 20px; border:none; border-radius:25px;
							background:#eee; cursor:pointer;">Cancel</button>
						`;

						overlay.appendChild(container);
						document.body.appendChild(overlay);

						const html5QrCode = new Html5Qrcode("qr_reader");

						const stopScanner = () => {
							html5QrCode.stop().catch(() => {});
							overlay.remove();
						};

						document.getElementById("closeScannerBtn").addEventListener("click", stopScanner);

						try {
							await html5QrCode.start(
							{ facingMode: "environment" },
							{ fps: 10, qrbox: { width: 250, height: 250 } },
							(decodedText) => {
								document.getElementById('scentCodeInput').value = decodedText;
								stopScanner();
							},
							(error) => console.log("Scanning...", error)
							);
						} catch (err) {
							alert("Cannot open camera: " + err);
							stopScanner();
						}
						});
					});
					]]>
				</script>

			</t>
		</template>
	</data>
</odoo>
